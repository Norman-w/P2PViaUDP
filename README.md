# P2P基于UDP的打洞套件

来自华为的解释:
https://info.support.huawei.com/info-finder/encyclopedia/zh/NAT.html

#### Full Cone NAT（完全锥型NAT）

  所有从同一个私网IP地址和端口（IP1:Port1）发送过来的请求都会被映射成同一个公网IP地址和端口（IP:Port）。并且，任何外部主机通过向映射的公网IP地址和端口发送报文，都可以实现和内部主机进行通信。

  这是一种比较宽松的策略，只要建立了私网IP地址和端口与公网IP地址和端口的映射关系，所有的Internet上的主机都可以访问该NAT之后的主机。

#### Restricted Cone NAT（限制锥型NAT）

  所有从同一个私网IP地址和端口（IP1:Port1）发送过来的请求都会被映射成同一个公网IP和端口号（IP:Port）。与完全锥型NAT不同的是，当且仅当内部主机之前已经向公网主机发送过报文，此时公网主机才能向私网主机发送报文。

#### Port Restricted Cone NAT（端口限制锥型NAT）

  与限制锥型NAT很相似，只不过它包括端口号。也就是说，一台公网主机（IP2:Port2）想给私网主机发送报文，必须是这台私网主机先前已经给这个IP地址和端口发送过报文。

#### Symmetric NAT（对称NAT）

  所有从同一个私网IP地址和端口发送到一个特定的目的IP地址和端口的请求，都会被映射到同一个IP地址和端口。如果同一台主机使用相同的源地址和端口号发送报文，但是发往不同的目的地，NAT将会使用不同的映射。此外，只有收到数据的公网主机才可以反过来向私网主机发送报文。

  这和端口限制锥型NAT不同，端口限制锥型NAT是所有请求映射到相同的公网IP地址和端口，而对称NAT是不同的请求有不同的映射。



## NAT类型:(该部分内容尚待重复验证)
###### _出发点指的相同一个P2PClient进程中,一个new UdpClient_
* 全锥形NAT:`客户端在访问服务器时,NAT设备会为客户端分配一个公网端口,这个端口可以由任何外部主机的任何端口访问`
  * 相同出发点,不同目标点:分配同到同一个出网时的公网端口
    * 相同出发点,同一服务器的不同端口:分配同到同一个出网时的公网端口
    * 相同出发点,不同服务器的相同端口:分配同到同一个出网时的公网端口
    * 相同出发点,不同服务器的不同端口:分配同到同一个出网时的公网端口
  * 不同出发点,相同目标点:各自分配不同的公网端口(端口号变化有规律) `⏳这个还没有测试过,是推测`
  * 不同出发点,不同目标点:各自分配不同的公网端口(端口号变化有规律)
* 地址限制型NAT:`只有客户端访问过的IP地址才能访问客户端的这个NAT外网端口,但是回信时使用的端口不限制`
  * 相同出发点,不同目标点:分配到不同的出网时的公网端口
  * 不同出发点,相同目标点:分配到不同的出网时的公网端口
* 端口限制型NAT:`只有客户端访问过的IP地址才能访问客户端的这个NAT外网端口,但是回信时使用的端口也要这个客户端之前访问过的`
* 对称型NAT:(根据现在测试看,端口非常随机)`只有客户端访问过的IP地址和端口才能访问客户端的这个NAT外网端口,比如自己的NAT是111.222.111.222:3333,访问的是111.111.111.111:4444,那么返回消息必须从111.111.111.111:4444发出去,这就表明如果我们111.111.111.111这个地址内网的主机如果不是全锥形的,端口稍微一变化,前者就无法正常通讯了,因为我们发不回去`
  * 相同出发点,不同目标点:分配到不同的出网时的公网端口
    * 相同出发点,同一服务器的不同端口:分配到不同的出网时的公网端口
    * 相同出发点,不同服务器的相同端口:分配到不同的出网时的公网端口
    * 相同出发点,不同服务器的不同端口:分配到不同的出网时的公网端口
  * 不同出发点,相同目标点:各自分配不同的公网端口
  * 不同出发点,不同目标点:各自分配不同的公网端口

## 图标:
* 锥形相关NAT:
  * 全锥形NAT:🎉
  * 地址限制型NAT:🌐
  * 端口限制型NAT:🧮
* 对称型NAT:🛡

运行测试客户端的sh脚本前请:
```bash
chmod +x run-docker.sh
```
再
```bash
./run-test-p2p-client-in-docker.sh
```

全锥形网络的拓扑参考:
```bash
d2 --watch udp-nat-p2p.d2
```
但是请注意在多数网络中运行时他并不一定能够起作用，因为大多数网络都是对称NAT，而不是全锥形NAT。
- [x] 在127.0.0.1环境下完全正常工作
- [x] STUN & TURN服务器在正式环境,两个客户机在同一个开发电脑正常工作(中国电信宽带)
- [x] 两个STUN服务端在不同的服务器,两个客户端在不同的网络环境下可正常检测出客户端为全锥形NAT
- [ ] STUN & TURN服务器在正式环境,一客户机在联通4G-WIFI棒下的客户端,一客户机在开发电脑中国电信宽带,不能正常工作**
